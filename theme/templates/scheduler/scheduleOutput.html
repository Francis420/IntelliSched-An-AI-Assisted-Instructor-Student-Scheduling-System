{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="p-6 md:p-10 bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Scheduler Results üìä</h1>
        <hr class="border-gray-300 mb-8">

        <div class="flex flex-col md:flex-row items-start justify-between space-y-4 md:space-y-0 mb-8 p-4 bg-white shadow-lg rounded-xl">
            
            <form id="schedule-select-form" method="GET" action="{% url 'scheduleOutput' %}" class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4 w-full md:w-2/3">
                
                <div class="flex items-center space-x-2 w-full md:w-1/2">
                    <label for="semester_select" class="text-sm font-medium text-gray-700 whitespace-nowrap">Semester:</label>
                    <select name="semester" id="semester_select" 
                            onchange="this.form.submit()"
                            class="form-select border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm py-2 px-3 w-full">
                        {% for sem in semesters %}
                            <option value="{{ sem.semesterId }}" {% if sem.semesterId|stringformat:"s" == current_semester_id|stringformat:"s" %}selected{% endif %}>
                                {{ sem.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="flex items-center space-x-2 w-full md:w-1/2">
                    <label for="batch_key_select" class="text-sm font-medium text-gray-700 whitespace-nowrap">Batch:</label>
                    <select name="batch_key" id="batch_key_select"
                            onchange="this.form.submit()"
                            class="form-select border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm py-2 px-3 w-full">
                        
                        {# Option for Finalized (if it exists) #}
                        {% if finalized_exists %}
                            <option value="finalized" {% if batch_key == 'finalized' %}selected{% endif %}>
                                Finalized Schedule (Locked)
                            </option>
                        {% endif %}

                        {# Option for Active Draft #}
                        <option value="active" {% if batch_key == 'active' %}selected{% endif %}>
                            Active Draft
                        </option>

                        {# Options for Archived Batches #}
                        {% for batch in archived_batches %}
                            <option value="{{ batch.key }}" {% if batch.key == batch_key %}selected{% endif %}>
                                {{ batch.label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </form>

            <div class="flex flex-col md:flex-row items-center space-y-2 md:space-y-0 md:space-x-3 w-full md:w-1/3 justify-end">

                {# --- ARCHIVED / REVERT LOGIC --- #}
                <div class="flex items-center space-x-2">
                    {% if batch_key != 'active' and batch_key != 'finalized' %}
                        {# We are viewing an Archived Batch #}
                        {% if finalized_exists %}
                            {# If a finalized schedule exists, DO NOT allow revert. Link to finalized instead. #}
                            <a href="{% url 'scheduleOutput' %}?semester={{ current_semester_id }}&batch_key=finalized" 
                               class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-600 text-white hover:bg-gray-700 transition duration-150 shadow-md whitespace-nowrap">
                                View Finalized
                            </a>
                        {% else %}
                            {# No finalized schedule exists, allow Revert #}
                            <button type="button" 
                                    onclick="document.getElementById('revert-form').submit()" 
                                    class="px-4 py-2 text-sm font-semibold rounded-lg bg-red-500 text-white hover:bg-red-600 transition duration-150 shadow-md whitespace-nowrap">
                                Revert to this Run
                            </button>
                        {% endif %}
                    {% endif %}
                </div>
                
                {# --- FINALIZE / UNLOCK LOGIC --- #}
                {% if can_finalize %}
                    <button type="button" 
                            onclick="confirmFinalize()"
                            class="px-4 py-2 text-sm font-semibold rounded-lg bg-green-500 text-white hover:bg-green-600 transition duration-150 shadow-md whitespace-nowrap">
                        Finalize Schedule
                    </button>
                {% elif is_finalized %}
                    {# Currently viewing Finalized Schedule - Show Unlock Button #}
                    <button type="button" 
                            onclick="confirmUnlock()"
                            class="px-4 py-2 text-sm font-semibold rounded-lg bg-yellow-500 text-white hover:bg-yellow-600 transition duration-150 shadow-md whitespace-nowrap">
                        üîí Unlock Schedule
                    </button>
                {% endif %}
            </div>
            
        </div>
        
        {# Django Messages Block #}
        {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
            <div class="p-4 rounded-lg text-sm {% if message.tags == 'error' %}bg-red-100 text-red-800{% elif message.tags == 'success' %}bg-green-100 text-green-800{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {# --- WARNING: Viewing Draft when Finalized Exists --- #}
        {% if batch_key == 'active' and finalized_exists %}
        <div class="mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg shadow-sm flex items-start space-x-3">
            <svg class="w-6 h-6 text-yellow-600 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div>
                <h3 class="font-bold text-yellow-800 text-lg">Finalized Schedule Available</h3>
                <p class="text-yellow-700 mt-1">
                    An official finalized schedule exists for this semester. You are currently viewing a draft.
                </p>
                <div class="mt-3">
                    <a href="{% url 'scheduleOutput' %}?semester={{ current_semester_id }}&batch_key=finalized" 
                       class="inline-block px-4 py-2 bg-yellow-600 text-white text-sm font-semibold rounded hover:bg-yellow-700 transition">
                        Go to Finalized Schedule &rarr;
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        {# CURRENT BATCH DISPLAY #}
        <div class="mb-8 p-4 bg-blue-50 border-l-4 border-blue-500 text-blue-800 rounded-lg shadow">
            <p class="text-sm font-medium">Currently viewing: <strong class="text-blue-900">{{ current_status }}</strong> for {{ current_semester.name }}.</p>
        </div>


        {# MAIN SCHEDULE AND METRICS CONTAINER #}
        <div class="grid grid-cols-1 gap-8">
            
            {# --- Instructor Load --- #}
        <div class="mt-8 bg-white shadow-xl rounded-xl p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Instructor Load Summary</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Instructor</th>
                            <th class="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Normal Load (Hrs)</th>
                            <th class="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Overload (Hrs)</th>
                            <th class="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Total Load (Hrs)</th>
                            {% for day in days_order %}
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">{{ day|slice:":3" }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for data in instructor_load_data %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">{{ data.name }}</td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 text-center">
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-lg font-semibold">{{ data.normal_hours|floatformat:2 }}</span>
                            </td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 text-center">
                                <span class="px-3 py-1 bg-red-100 text-red-800 rounded-lg font-semibold">{{ data.overload_hours|floatformat:2 }}</span>
                            </td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 text-center">
                                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-lg font-semibold">{{ data.total_hours|floatformat:2 }}</span>
                            </td>
                            {% for day_data in data.daily_spread_list %}
                            <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-700 text-center">{{ day_data.hours|floatformat:1 }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

            {# --- Room Usage --- #}
            <div class="bg-white shadow-xl rounded-xl p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Room Utilization</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Room Code</th>
                                <th class="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Total Usage (Hours)</th>
                                {# Daily Spread Headers for Rooms #}
                                {% for day in days_order %}
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">{{ day|slice:":3" }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for data in room_usage_data %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-800 font-medium">
                                    {% if data.room_code == 'TBA' %}
                                    <strong class="text-red-600">‚ö†Ô∏è {{ data.room_code }} (Unassigned)</strong>
                                    {% else %}
                                    {{ data.room_code }}
                                    {% endif %}
                                </td>
                                <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 text-center">
                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-lg font-semibold">{{ data.usage_hours|floatformat:2 }}</span>
                                </td>
                                {# Daily Spread Cells for Rooms #}
                                {% for day_data in data.daily_spread_list %}
                                <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-700 text-center">{{ day_data.hours|floatformat:1 }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div> 
        </div>
    </div>
</div>

{# --- Hidden Forms for Actions --- #}

{# 1. Finalize Form #}
<form id="finalize-form" method="POST" 
      action="{% url 'finalizeSchedule' current_semester_id %}" 
      class="hidden">
    {% csrf_token %}
    <input type="hidden" name="semester_id" value="{{ current_semester_id }}">
</form>

{# 2. Revert (Archive) Form #}
<form id="revert-form" method="POST" action="{% url 'revertSchedule' %}" class="hidden">
    {% csrf_token %}
    <input type="hidden" name="semester_id" value="{{ current_semester_id }}">
    <input type="hidden" name="batch_key" value="{{ batch_key }}">
</form>

{# 3. Unlock (Unfinalize) Form - NEW #}
<form id="unlock-form" method="POST" 
      action="{% url 'revertFinalizedSchedule' current_semester_id %}" 
      class="hidden">
    {% csrf_token %}
</form>


<script>
    function confirmFinalize() {
        var message = "WARNING: Finalizing will lock this schedule and make it the official schedule for {{ current_semester.name }}. Proceed?";
        if (confirm(message)) {
            document.getElementById('finalize-form').submit();
        }
    }

    function confirmUnlock() {
        if (confirm("Are you sure you want to UNLOCK this schedule?")) {
            document.getElementById('unlock-form').submit();
        }
    }
</script>

{% endblock content %}