{% extends 'base.html' %}
{% block header %}| Scheduling Control Panel{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto p-8 space-y-6">
  {% if semester %}
    <div class="bg-white shadow border border-gray-100 rounded-xl p-6">
      <p class="text-gray-600 mb-4">
        <strong>Active Semester:</strong> {{ semester.name }}
      </p>

      <div id="statusBox" class="bg-gray-50 border rounded-lg p-4 mb-4 text-gray-700">
        <p id="statusText">Idle</p>
      </div>

      <div class="flex gap-3">
        <button id="startBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg font-medium">
          ▶ Start Scheduling
        </button>

        <button id="stopBtn" class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg font-medium hidden">
          ✖ Stop
        </button>
      </div>
    </div>
  {% else %}
    <p class="text-gray-500">No active semester found.</p>
  {% endif %}
</div>

<script>
let taskId = null;
let checkInterval = null;

document.getElementById("startBtn")?.addEventListener("click", () => {
  document.getElementById("statusText").textContent = "Starting scheduling...";
  fetch("{% url 'start_scheduler' %}", { method: "POST", headers: {"X-CSRFToken": "{{ csrf_token }}"} })
    .then(res => res.json())
    .then(data => {
      if (data.task_id) {
        taskId = data.task_id;
        document.getElementById("startBtn").classList.add("hidden");
        document.getElementById("stopBtn").classList.remove("hidden");
        startPolling();
      } else {
        document.getElementById("statusText").textContent = "Error: " + (data.error || "Unknown");
      }
    });
});

function startPolling() {
  checkInterval = setInterval(() => {
    fetch(`/scheduler/status/${taskId}/`)
      .then(res => res.json())
      .then(data => {
        const state = data.state;
        const info = data.info;
        document.getElementById("statusText").textContent =
          `Status: ${state}${info && info.progress ? " - " + info.progress : ""}`;

        if (state === "SUCCESS" || state === "FAILURE") {
          clearInterval(checkInterval);
          document.getElementById("stopBtn").classList.add("hidden");
          document.getElementById("startBtn").classList.remove("hidden");
        }
      });
  }, 3000);
}

document.getElementById("stopBtn")?.addEventListener("click", () => {
  clearInterval(checkInterval);
  document.getElementById("statusText").textContent = "Scheduling cancelled.";
  document.getElementById("stopBtn").classList.add("hidden");
  document.getElementById("startBtn").classList.remove("hidden");
});
</script>
{% endblock %}
