{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
    .sheet-container {
        width: 100%; max-width: 1200px; margin: 0 auto;
        background: white; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
        font-family: "Times New Roman", serif;
    }
    .sheet-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 12px; }
    .sheet-table th, .sheet-table td { border: 1px solid #000; padding: 4px; text-align: center; vertical-align: middle; }
    .sheet-input { 
        width: 100%; border: none; outline: none; text-align: center; 
        background: transparent; font-family: inherit; font-size: inherit; 
    }
    .sheet-input:focus { background-color: #eef; }
    .text-left { text-align: left !important; }
    .text-right { text-align: right !important; }
    .font-bold { font-weight: bold; }
    
    /* Involvement section specific inputs */
    .inv-input { border-bottom: 1px solid #000; width: 60px; text-align: center; }
    .inv-text { border-bottom: 1px solid #000; width: 200px; text-align: left; padding-left: 5px; }
</style>

<div class="p-6 bg-gray-100 min-h-screen">
    <div class="mb-4 flex justify-between items-center max-w-[1200px] mx-auto">
        <h2 class="text-xl font-bold text-gray-800">Instructor Workload Preview</h2>
        <button type="submit" form="workloadForm" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 shadow transition">
            Export to Excel
        </button>
    </div>

    <form id="workloadForm" action="{% url 'exportWorkloadExcel' %}" method="POST" class="sheet-container">
        {% csrf_token %}

        <div class="text-center mb-6 relative">
            <div class="font-bold text-sm">EASTERN VISAYAS STATE UNIVERSITY</div>
            <div class="text-sm">Tacloban City</div>
            <h1 class="font-bold text-lg mt-2">ACTUAL TEACHING LOAD</h1>
            <div class="absolute top-0 right-0 text-xs text-left">
                <div>EVSU-ACA-F-002</div>
                <div>Rev 002</div>
                <div>Date: February 20, 2023</div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 text-sm mb-4">
            <div>
                <div class="flex mb-1">
                    <span class="w-32">Faculty:</span>
                    <input type="text" name="header_faculty" value="{{ instructor.full_name|upper }}" class="sheet-input border-b border-black text-left flex-1 font-bold">
                </div>
                <div class="flex mb-1">
                    <span class="w-32">Rank:</span>
                    <input type="text" name="header_rank" value="{{ instructor.rank.name|upper }}" class="sheet-input border-b border-black text-left flex-1">
                </div>
                <div class="flex mb-1">
                    <span class="w-32">College:</span>
                    <input type="text" name="header_college" value="SCHOOL OF ENGINEERING" class="sheet-input border-b border-black text-left flex-1">
                </div>
            </div>
            <div>
                <div class="flex mb-1">
                    <span class="w-32">Semester:</span>
                    <input type="text" name="header_semester" value="{{ semester_text }}" class="sheet-input border-b border-black text-left flex-1">
                </div>
                <div class="flex mb-1">
                    <span class="w-32">School Year:</span>
                    <input type="text" name="header_sy" value="{{ semester.academicYear }}" class="sheet-input border-b border-black text-left flex-1">
                </div>
            </div>
        </div>

        <div class="mb-1 font-bold text-sm">REGULAR</div>
        <table class="sheet-table" id="regularTable">
            <thead>
                <tr>
                    <th rowspan="2" width="8%">COURSE NO.</th>
                    <th rowspan="2" width="25%">DESCRIPTIVE TITLE</th>
                    <th rowspan="2" width="5%">UNITS</th>
                    <th rowspan="2" width="12%">TIME</th>
                    <th rowspan="2" width="8%">DAYS</th>
                    <th colspan="3">No. of Hrs./Week</th>
                    <th rowspan="2" width="6%">No. of Students</th>
                    <th rowspan="2" width="8%">ROOM NO.</th>
                    <th rowspan="2" width="10%">Course, Yr., & Sec.</th>
                </tr>
                <tr>
                    <th width="5%">Lec</th>
                    <th width="5%">Lab</th>
                    <th width="5%">TOTAL</th>
                </tr>
            </thead>
            <tbody>
                {% for row in regular_rows %}
                <tr>
                    <td><input type="text" name="reg_code[]" value="{{ row.code }}" class="sheet-input"></td>
                    <td><input type="text" name="reg_title[]" value="{{ row.description }}" class="sheet-input text-left"></td>
                    <td><input type="text" name="reg_units[]" value="{{ row.units }}" class="sheet-input"></td>
                    <td><input type="text" name="reg_time[]" value="{{ row.time }}" class="sheet-input" style="font-size: 11px;"></td>
                    <td><input type="text" name="reg_days[]" value="{{ row.days }}" class="sheet-input"></td>
                    <td><input type="text" name="reg_lec[]" value="{{ row.lec }}" class="sheet-input"></td>
                    <td><input type="text" name="reg_lab[]" value="{{ row.lab }}" class="sheet-input"></td>
                    <td><span class="row-total"></span></td>
                    <td><input type="text" name="reg_students[]" value="{{ row.students }}" class="sheet-input"></td>
                    <td><input type="text" name="reg_room[]" value="{{ row.room }}" class="sheet-input"></td>
                    <td><input type="text" name="reg_section[]" value="{{ row.section }}" class="sheet-input"></td>
                </tr>
                {% empty %}
                <tr><td colspan="11" class="text-gray-500 italic">No regular load assigned.</td></tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="font-bold bg-gray-50">
                    <td colspan="2" class="text-right px-4">TOTAL</td>
                    <td>{{ regular_totals.units }}</td>
                    <td></td>
                    <td></td>
                    <td>{{ regular_totals.lec }}</td>
                    <td>{{ regular_totals.lab }}</td>
                    <td id="regTotalHrs"></td>
                    <td colspan="3"></td>
                </tr>
            </tfoot>
        </table>

        <div class="mb-1 font-bold text-sm mt-4">OVERLOAD / PART-TIME</div>
        <table class="sheet-table" id="overloadTable">
            <thead>
                <tr>
                    <th rowspan="2" width="8%">COURSE NO.</th>
                    <th rowspan="2" width="25%">DESCRIPTIVE TITLE</th>
                    <th rowspan="2" width="5%">UNITS</th>
                    <th rowspan="2" width="12%">TIME</th>
                    <th rowspan="2" width="8%">DAYS</th>
                    <th colspan="3">No. of Hrs./Week</th>
                    <th rowspan="2" width="6%">No. of Students</th>
                    <th rowspan="2" width="8%">ROOM NO.</th>
                    <th rowspan="2" width="10%">Course, Yr., & Sec.</th>
                </tr>
                <tr>
                    <th>Lec</th>
                    <th>Lab</th>
                    <th>TOTAL</th>
                </tr>
            </thead>
            <tbody id="overloadBody">
                {% for row in overload_rows %}
                <tr>
                    <td><input type="text" name="over_code[]" value="{{ row.code }}" class="sheet-input"></td>
                    <td><input type="text" name="over_title[]" value="{{ row.description }}" class="sheet-input text-left"></td>
                    <td><input type="text" name="over_units[]" value="{{ row.units }}" class="sheet-input"></td>
                    <td><input type="text" name="over_time[]" value="{{ row.time }}" class="sheet-input" style="font-size: 11px;"></td>
                    <td><input type="text" name="over_days[]" value="{{ row.days }}" class="sheet-input"></td>
                    <td><input type="text" name="over_lec[]" value="{{ row.lec }}" class="sheet-input"></td>
                    <td><input type="text" name="over_lab[]" value="{{ row.lab }}" class="sheet-input"></td>
                    <td><span class="row-total"></span></td>
                    <td><input type="text" name="over_students[]" value="{{ row.students }}" class="sheet-input"></td>
                    <td><input type="text" name="over_room[]" value="{{ row.room }}" class="sheet-input"></td>
                    <td><input type="text" name="over_section[]" value="{{ row.section }}" class="sheet-input"></td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="font-bold bg-gray-50">
                    <td colspan="2" class="text-right px-4">TOTAL</td>
                    <td>{{ overload_totals.units }}</td>
                    <td></td>
                    <td></td>
                    <td>{{ overload_totals.lec }}</td>
                    <td>{{ overload_totals.lab }}</td>
                    <td id="overTotalHrs"></td>
                    <td colspan="3"></td>
                </tr>
            </tfoot>
        </table>
        
        <div class="text-right mb-4">
            <button type="button" onclick="addOverloadRow()" class="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded">
                + Add Overload Row
            </button>
        </div>

        <div class="grid grid-cols-2 gap-8 text-sm mt-6">
            <div>
                <div class="font-bold mb-2">Other In-School Involvement/Assignment Per Week</div>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span>Administrative:</span>
                        <div>
                            <input type="number" step="0.1" name="inv_admin" value="{{ inv_admin }}" class="inv-input inv-calc"> Hours
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Research:</span>
                        <div>
                            <input type="number" step="0.1" name="inv_research" value="{{ inv_research }}" class="inv-input inv-calc"> Hours
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Extension Services:</span>
                        <div>
                            <input type="number" step="0.1" name="inv_extension" value="{{ inv_extension }}" class="inv-input inv-calc"> Hours
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Instructional Functions:</span>
                        <div>
                            <input type="number" step="0.1" name="inv_consultation" value="{{ inv_consultation }}" class="inv-input inv-calc"> Hours
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <span class="mr-2">Others:</span>
                            <input type="text" name="inv_note" value="{% if inv_others > 0 %}Production{% endif %}" placeholder="(Please Specify)" class="inv-text text-xs">
                        </div>
                        <div>
                            <input type="number" step="0.1" name="inv_others" value="{{ inv_others }}" class="inv-input inv-calc"> Hours
                        </div>
                    </div>
                </div>
            </div>

            <div class="pl-8 border-l border-gray-300">
                <div class="font-bold mb-2">Summary</div>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span>No. of Classes:</span>
                        <input type="text" name="inv_classes" value="{{ involvement_data.no_of_classes }}" class="inv-input">
                    </div>
                    <div class="flex justify-between items-center font-bold text-lg mt-4">
                        <span>Total Workload:</span>
                        <div>
                            <span id="grandTotalDisplay">{{ involvement_data.total }}</span> Hours
                            <input type="hidden" name="inv_total" id="grandTotalInput" value="{{ involvement_data.total }}">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-12 pt-8 border-t-2 border-gray-800">
            <div class="grid grid-cols-4 gap-4 text-center text-sm">
                <div>
                    <div class="mb-8">Conforme:</div>
                    <div class="px-2">
                        <input type="text" name="sig_faculty" value="{{ instructor.full_name|upper }}" class="sheet-input font-bold border-b border-black">
                        <div class="mt-1">Faculty Member</div>
                    </div>
                </div>
                <div>
                    <div class="mb-8">Recommending Approval:</div>
                    <div class="px-2">
                        <input type="text" name="sig_dept_head" value="{{ dept_head_name }}" class="sheet-input font-bold border-b border-black">
                        <div class="mt-1">Department Head</div>
                    </div>
                </div>
                <div>
                    <div class="mb-8">&nbsp;</div>
                    <div class="px-2">
                        <input type="text" name="sig_dean" value="MA. SALOME C. LISONDRA" class="sheet-input font-bold border-b border-black">
                        <div class="mt-1">Dean</div>
                    </div>
                </div>
                <div>
                    <div class="mb-8">Approved:</div>
                    <div class="px-2">
                        <input type="text" name="sig_vp" value="BENEDICTO T. MILITANTE JR." class="sheet-input font-bold border-b border-black">
                        <div class="mt-1">Vice President for Academic Affairs</div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-center mt-8">
                <div class="text-center w-1/4">
                    <input type="text" name="sig_president" value="{{ curriculum.universityPresident|upper|default:'DR. DENNIS C. DE PAZ' }}" class="sheet-input font-bold border-b border-black">
                    <div class="mt-1">University President</div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    function calculateRowTotal(row) {
        // Find inputs for lec and lab in this specific row
        // Note: Using name^= selector to find inputs starting with specific names
        const lecInput = row.querySelector('input[name*="lec"]');
        const labInput = row.querySelector('input[name*="lab"]');
        const totalSpan = row.querySelector('.row-total');
        
        const lec = parseFloat(lecInput.value) || 0;
        const lab = parseFloat(labInput.value) || 0;
        const total = lec + lab;
        
        totalSpan.textContent = total > 0 ? total : '';
        return total;
    }

    function calculateAllTotals() {
        let regTotal = 0;
        let overTotal = 0;

        document.querySelectorAll('#regularTable tbody tr').forEach(row => {
            regTotal += calculateRowTotal(row);
        });
        document.getElementById('regTotalHrs').textContent = regTotal > 0 ? regTotal : '';

        document.querySelectorAll('#overloadTable tbody tr').forEach(row => {
            overTotal += calculateRowTotal(row);
        });
        document.getElementById('overTotalHrs').textContent = overTotal > 0 ? overTotal : '';

        // Calculate Involvement Total
        let invTotal = 0;
        document.querySelectorAll('.inv-calc').forEach(inp => {
            invTotal += parseFloat(inp.value) || 0;
        });

        // Update Grand Total (Teaching Load + Involvement)
        // Note: Usually Total Workload includes Teaching Load hours + Involvement
        // Adjust logic if Total Workload is ONLY Involvement
        
        // Assuming Total Workload = Involvement Sum (based on your template structure)
        const grandTotal = invTotal; 
        
        document.getElementById('grandTotalDisplay').textContent = grandTotal.toFixed(1);
        document.getElementById('grandTotalInput').value = grandTotal;
    }

    // Add event listeners to all inputs for real-time calc
    document.addEventListener('input', function(e) {
        if (e.target.matches('input[name*="lec"], input[name*="lab"], .inv-calc')) {
            calculateAllTotals();
        }
    });

    // Initial Calculation
    calculateAllTotals();

    function addOverloadRow() {
        const tbody = document.getElementById('overloadBody');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" name="over_code[]" class="sheet-input"></td>
            <td><input type="text" name="over_title[]" class="sheet-input text-left"></td>
            <td><input type="text" name="over_units[]" class="sheet-input"></td>
            <td><input type="text" name="over_time[]" class="sheet-input" style="font-size: 11px;"></td>
            <td><input type="text" name="over_days[]" class="sheet-input"></td>
            <td><input type="text" name="over_lec[]" class="sheet-input"></td>
            <td><input type="text" name="over_lab[]" class="sheet-input"></td>
            <td><span class="row-total"></span></td>
            <td><input type="text" name="over_students[]" class="sheet-input"></td>
            <td><input type="text" name="over_room[]" class="sheet-input"></td>
            <td><input type="text" name="over_section[]" class="sheet-input"></td>
        `;
        tbody.appendChild(row);
    }
</script>
{% endblock %}