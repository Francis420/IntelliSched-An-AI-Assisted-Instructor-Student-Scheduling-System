{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="w-full p-2">

    <div class="flex flex-row h-[85vh] bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden relative">

        <div class="flex-1 flex flex-col h-full min-w-0 relative z-0">
            
            <div class="bg-white border-b border-gray-200 z-30 shadow-sm px-4 py-3 flex justify-between items-center">
                <div>
                    <h1 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                        Room Assignment
                    </h1>
                    <p class="text-xs text-gray-500">
                        Viewing: <span class="font-bold text-indigo-600">{{ selectedRoomLabel|default:"Select a room" }}</span>
                    </p>
                </div>
                
                <form method="get" class="flex items-center gap-2">
                    <select name="room" class="border-gray-300 border rounded text-xs px-2 py-1.5 bg-gray-50 text-gray-700 font-medium focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm" onchange="this.form.submit()">
                        <option value="" disabled {% if not selectedRoomId %}selected{% endif %}>-- Select Room --</option>
                        {% regroup rooms by building as building_list %}
                        {% for building in building_list %}
                            <optgroup label="{{ building.grouper }}">
                                {% for r in building.list %}
                                    <option value="{{ r.roomId }}" {% if selectedRoomId == r.roomId %}selected{% endif %}>
                                        {{ r.roomCode }}
                                    </option>
                                {% endfor %}
                            </optgroup>
                        {% endfor %}
                    </select>
                </form>
            </div>

            <div class="grid grid-cols-7 border-b border-gray-200 bg-gray-50 flex-none">
                <div class="py-2 text-center text-[10px] font-bold text-gray-400 uppercase tracking-wider border-r">Time</div>
                {% for day in days %}
                    <div class="py-2 text-center text-xs font-bold text-gray-600 border-r uppercase">{{ day|slice:":3" }}</div>
                {% endfor %}
            </div>

            <div class="flex-1 overflow-y-auto relative bg-white custom-scrollbar" id="scheduleGrid" 
                 ondragover="allowDrop(event)" 
                 ondrop="handleGridDrop(event)">
                
                <div class="grid grid-cols-7 min-h-[800px] relative">
                    
                    <div class="border-r border-gray-100 bg-gray-50/50 z-10 sticky left-0">
                        {% for t in times %}
                            <div class="h-12 border-b border-gray-100 text-[10px] text-gray-400 flex items-start justify-center pt-1 font-mono">
                                {{ t|time:"g A" }}
                            </div>
                        {% endfor %}
                    </div>

                    {% for day in days %}
                    <div class="relative border-r border-gray-100 day-column group" data-day="{{ day }}">
                        {% for t in times %}
                            {% if t.hour == 12 %}
                                <div class="h-12 border-b border-gray-100 bg-gray-100 flex items-center justify-center pointer-events-none select-none">
                                    <span class="text-[10px] font-bold text-gray-400 tracking-widest uppercase opacity-70">Lunch Break</span>
                                </div>
                            {% else %}
                                <div class="h-12 border-b border-gray-100 hover:bg-indigo-50/50 transition-colors cursor-pointer slot-trigger" 
                                     data-time="{{ t|time:'H:i' }}"></div>
                            {% endif %}
                        {% endfor %}

                        <div class="conflict-layer absolute inset-0 pointer-events-none z-0"></div>

                        {% for sched in schedules %}
                            {% if sched.dayOfWeek == day %}
                            <div class="schedule-card absolute w-[94%] left-[3%] rounded bg-emerald-50 border-l-4 border-emerald-500 p-1 shadow-sm hover:shadow-md cursor-grab active:cursor-grabbing transition-all z-20 hover:scale-[1.02] group overflow-hidden"
                                 draggable="true"
                                 data-id="{{ sched.scheduleId }}"
                                 data-start="{{ sched.startTime|time:'H:i' }}"
                                 data-duration="{{ sched.duration_minutes }}"
                                 data-instructor="{{ sched.instructor.full_name }}"
                                 data-instructorid="{{ sched.instructor.instructorId }}"
                                 data-subject="{{ sched.subject.code }}"
                                 data-section="{{ sched.formatted_section }}"
                                 data-type="{{ sched.type|default:'Lecture' }}" 
                                 ondragstart="handleDragStart(event)"
                                 ondragend="handleDragEnd(event)" 
                                 onclick="onCardClick(this)">
                                 
                                <div class="flex flex-col justify-between h-full w-full pointer-events-none">
                                    <div>
                                        <div class="font-bold text-emerald-900 text-[10px] leading-tight truncate">
                                            {{ sched.subject.code }} - {{ sched.formatted_section }}
                                        </div>
                                        <div class="text-[9px] text-emerald-700 font-medium truncate">
                                            {{ sched.type|default:"Lecture" }}
                                        </div>
                                        <div class="text-[9px] text-emerald-600 uppercase truncate mt-0.5">
                                            {{ sched.instructor.full_name }}
                                        </div>
                                    </div>
                                    <div class="text-[8px] text-emerald-800 font-mono leading-none mt-1 border-t border-emerald-200 pt-0.5">
                                        {{ sched.startTime|time:"g:iA" }} - {{ sched.endTime|time:"g:iA" }}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="w-72 bg-gray-50 flex flex-col border-l border-gray-200 transition-all duration-300 relative z-20 flex-none" id="tbaSidebar">
            
            <div class="p-4 bg-white border-b border-gray-200">
                <h2 class="text-xs font-bold text-gray-700 uppercase tracking-wide flex justify-between items-center mb-2">
                    Unassigned / TBA
                    <span id="tbaCount" class="bg-indigo-100 text-indigo-700 text-[10px] px-2 py-0.5 rounded-full font-bold">{{ tba_schedules|length }}</span>
                </h2>
                
                <div class="relative">
                    <input type="text" id="sidebarSearch" onkeyup="filterSidebar()" placeholder="Search..."
                           class="w-full text-xs border border-gray-300 rounded px-2 py-1.5 pl-7 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <svg class="w-3 h-3 text-gray-400 absolute left-2 top-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>

            <div id="tba-drop-zone" 
                 class="mx-3 mt-3 p-3 border-2 border-dashed border-gray-300 rounded-lg text-center bg-gray-100 hover:bg-red-50 hover:border-red-300 hover:text-red-500 transition-all cursor-default"
                 ondragover="allowDrop(event)" 
                 ondrop="handleRemoveDrop(event)">
                 <div class="pointer-events-none">
                    <span class="text-[10px] font-bold uppercase">Drop here to Unassign</span>
                 </div>
            </div>

            <div class="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar" id="tbaList">
                {% for sched in tba_schedules %}
                <div class="tba-card schedule-card bg-white border border-gray-200 border-l-4 border-l-amber-400 p-2 rounded shadow-sm hover:shadow-md cursor-grab active:cursor-grabbing transition-all group relative mb-2"
                     draggable="true"
                     data-id="{{ sched.scheduleId }}"
                     data-start="00:00" 
                     data-duration="{{ sched.duration_minutes }}"
                     data-instructorid="{{ sched.instructor.instructorId }}"
                     data-instructor="{{ sched.instructor.full_name }}"
                     data-subject="{{ sched.subject.code }}"
                     data-section="{{ sched.formatted_section }}"
                     data-type="{{ sched.type|default:'Lecture' }}"
                     data-search="{{ sched.subject.code }} {{ sched.formatted_section }} {{ sched.instructor.full_name }}"
                     ondragstart="handleDragStart(event)"
                     ondragend="handleDragEnd(event)" 
                     onclick="onCardClick(this)">
                     
                     <div class="flex justify-between items-start pointer-events-none">
                         <div class="font-bold text-gray-800 text-[10px]">
                             {{ sched.subject.code }} <span class="text-amber-600 ml-1">{{ sched.formatted_section }}</span>
                         </div>
                         <span class="text-[9px] bg-gray-100 text-gray-500 px-1 rounded border border-gray-200">{{ sched.duration_minutes }}m</span>
                     </div>
                     <div class="text-[9px] text-gray-500 truncate pointer-events-none">
                        {{ sched.type|default:"Lecture" }}
                     </div>
                     <div class="text-[9px] text-gray-500 truncate pointer-events-none">
                         {{ sched.instructor.full_name }}
                     </div>
                </div>
                {% empty %}
                {% endfor %}
                
                <div id="noSearchResults" class="hidden text-center py-4">
                    <p class="text-[10px] text-gray-400">No matches found</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="infoModal" class="hidden fixed bottom-6 right-80 z-50 animate-bounce-in">
    <div class="bg-white p-4 rounded-lg shadow-2xl border border-indigo-200 w-72">
        <div class="flex justify-between items-center mb-2">
            <h3 class="font-bold text-gray-800 text-sm">Class Details</h3>
            <button onclick="clearSelection()" class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        <div id="modalContent" class="text-xs text-gray-600 space-y-1"></div>
    </div>
</div>

<script>
    const CURRENT_ROOM_ID = "{{ selectedRoomId }}"; 
    const START_HOUR = 7; 
    const PIXELS_PER_HOUR = 48; 
    const API_URL_CONFLICTS = "{% url 'getInstructorConflicts' %}"; 
    
    let dragCardOffsetY = 0;

    // --- UTILS ---
    function getCookie(name) {
        let v = null;
        if (document.cookie && document.cookie !== '') {
            document.cookie.split(';').forEach(c => {
                const cookie = c.trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    v = decodeURIComponent(cookie.substring(name.length + 1));
                }
            });
        }
        return v;
    }

    function formatTime12(timeStr) {
        const [h, m] = timeStr.split(':').map(Number);
        const ampm = h >= 12 ? 'PM' : 'AM';
        const h12 = h % 12 || 12;
        return `${h12}:${m.toString().padStart(2,'0')}${ampm}`;
    }

    // --- SEARCH ---
    function filterSidebar() {
        const input = document.getElementById('sidebarSearch').value.toLowerCase();
        document.querySelectorAll('.tba-card').forEach(card => {
            const txt = card.dataset.search.toLowerCase();
            card.style.display = txt.includes(input) ? "block" : "none";
        });
        
        const hasVisible = Array.from(document.querySelectorAll('.tba-card')).some(e => e.style.display === "block");
        const noRes = document.getElementById('noSearchResults');
        if(noRes) noRes.classList.toggle('hidden', !hasVisible);
    }

    // --- SELECTION & CLEANUP ---
    function clearSelection() {
        document.querySelectorAll('.schedule-card').forEach(el => {
            el.classList.remove('ring-2', 'ring-indigo-500', 'z-50');
        });
        document.getElementById('infoModal').classList.add('hidden');
        document.querySelectorAll('.conflict-box').forEach(el => el.remove());
    }

    // --- CONFLICTS ---
    async function fetchConflicts(instructorId, currentId) {
        document.querySelectorAll('.conflict-box').forEach(el => el.remove());
        try {
            const url = `${API_URL_CONFLICTS}?instructorId=${instructorId}&scheduleId=${currentId}`;
            const res = await fetch(url);
            if(!res.ok) throw new Error("API Error");
            const data = await res.json();
            
            data.busySlots.forEach(slot => {
                const dayCol = document.querySelector(`.day-column[data-day="${slot.day}"] .conflict-layer`);
                if(dayCol) {
                    const [sh, sm] = slot.startTime.split(':').map(Number);
                    const [eh, em] = slot.endTime.split(':').map(Number);
                    const top = (sh + sm/60 - START_HOUR) * PIXELS_PER_HOUR;
                    const height = (eh + em/60 - (sh + sm/60)) * PIXELS_PER_HOUR;
                    
                    const div = document.createElement('div');
                    div.className = "conflict-box absolute w-full left-0 bg-red-200/80 border-y border-red-500 flex flex-col items-center justify-center z-10 pointer-events-none p-1 text-center leading-tight animate-pulse";
                    div.style.top = `${top}px`;
                    div.style.height = `${height}px`;
                    div.innerHTML = `<span class="text-[9px] font-bold text-red-900 uppercase">BUSY</span><span class="text-[8px] text-red-900 line-clamp-2">${slot.reason}</span>`;
                    dayCol.appendChild(div);
                }
            });
        } catch(e) { console.error(e); }
    }

    // --- INTERACTIONS ---
    function onCardClick(element) {
        clearSelection();
        element.classList.add('ring-2', 'ring-indigo-500', 'z-50');

        const modal = document.getElementById('infoModal');
        const content = document.getElementById('modalContent');
        content.innerHTML = `
            <p><strong>Subj:</strong> ${element.dataset.subject}</p>
            <p><strong>Type:</strong> ${element.dataset.type}</p>
            <p><strong>Prof:</strong> ${element.dataset.instructor}</p>
            <p><strong>Time:</strong> ${element.dataset.start} (${element.dataset.duration}m)</p>
            <div class="mt-2 pt-2 border-t border-gray-100 bg-red-50 p-2 rounded text-red-800">
                <p class="text-[10px] font-bold">Conflict Check Active:</p>
                <p class="text-[9px]">Red boxes on the grid show where this Instructor is busy.</p>
            </div>
        `;
        modal.classList.remove('hidden');

        if(element.dataset.instructorid) fetchConflicts(element.dataset.instructorid, element.dataset.id);
    }

    // --- KEYBOARD LISTENERS (ESC) ---
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            clearSelection();
        }
    });

    // --- DRAG HANDLERS ---
    function handleDragStart(e) {
        const rect = e.target.getBoundingClientRect();
        dragCardOffsetY = e.clientY - rect.top;

        e.dataTransfer.setData("text/plain", e.target.dataset.id);
        e.dataTransfer.setData("duration", e.target.dataset.duration);
        e.dataTransfer.setData("subject", e.target.dataset.subject);
        e.dataTransfer.setData("section", e.target.dataset.section);
        e.dataTransfer.setData("instructor", e.target.dataset.instructor);
        // Pass the Type as well
        e.dataTransfer.setData("type", e.target.dataset.type);

        e.target.style.opacity = '0.5';
        
        if(e.target.dataset.instructorid) fetchConflicts(e.target.dataset.instructorid, e.target.dataset.id);
        document.getElementById('infoModal').classList.add('hidden');
    }

    function handleDragEnd(e) {
        if(e.target) e.target.style.opacity = '1';
        clearSelection();
    }

    function allowDrop(e) { e.preventDefault(); }

    function handleGridDrop(e) {
        e.preventDefault();
        const scheduleId = e.dataTransfer.getData("text/plain");
        
        let target = e.target;
        while (!target.classList.contains('slot-trigger') && !target.classList.contains('day-column')) {
            target = target.parentElement;
            if(!target) return; 
        }

        if (target.classList.contains('slot-trigger')) {
            const dayColumn = target.closest('.day-column');
            const day = dayColumn.dataset.day;
            const slotTime = target.dataset.time; 
            const [h, m] = slotTime.split(':').map(Number);
            
            const rect = target.getBoundingClientRect();
            const mouseInSlotY = e.clientY - rect.top;
            const cardTopInSlotY = Math.max(0, mouseInSlotY - dragCardOffsetY);
            const finalM = cardTopInSlotY > 24 ? 30 : 0; 

            const duration = parseInt(e.dataTransfer.getData("duration"));
            const startDec = h + (finalM/60);
            const endDec = startDec + (duration/60);

            if (startDec < 13 && endDec > 12) {
                alert("Cannot schedule across Lunch Break (12-1 PM).");
                handleDragEnd({target: document.querySelector(`.schedule-card[data-id="${scheduleId}"]`)});
                return;
            }

            const startTimeStr = `${h.toString().padStart(2,'0')}:${finalM===0?'00':'30'}`;
            const eh = Math.floor(endDec);
            const em = (endDec % 1) * 60;
            const endTimeStr = `${eh.toString().padStart(2,'0')}:${Math.round(em)===0?'00':'30'}`;

            updateSchedule(scheduleId, day, startTimeStr, endTimeStr, CURRENT_ROOM_ID, false);
        }
    }

    function handleRemoveDrop(e) {
        e.preventDefault();
        const scheduleId = e.dataTransfer.getData("text/plain");
        const duration = parseInt(e.dataTransfer.getData("duration"));

        if(confirm("Remove this class from the current room?")) {
            const h = Math.floor(duration / 60);
            const m = duration % 60;
            const endTimeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            updateSchedule(scheduleId, 'TBA', '00:00', endTimeStr, 'TBA', false);
        } else {
            handleDragEnd({target: document.querySelector(`.schedule-card[data-id="${scheduleId}"]`)});
        }
    }

    // --- SEAMLESS UPDATE ---
    function updateSchedule(id, day, start, end, roomId, forceSwap) {
        fetch('{% url "updateScheduleSlot" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ scheduleId: id, day: day, startTime: start, endTime: end, roomId: roomId, forceSwap: forceSwap })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                applySeamlessUpdate(id, day, start, end, roomId);
            } else if (data.needSwapConfirmation) {
                if (confirm(data.message)) {
                    updateSchedule(id, day, start, end, roomId, true); 
                } else {
                    handleDragEnd({target: document.querySelector(`.schedule-card[data-id="${id}"]`)});
                }
            } else {
                alert(data.message);
                handleDragEnd({target: document.querySelector(`.schedule-card[data-id="${id}"]`)});
            }
        })
        .catch(err => {
            console.error(err);
            handleDragEnd({target: document.querySelector(`.schedule-card[data-id="${id}"]`)});
        });
    }

    function applySeamlessUpdate(id, day, start, end, roomId) {
        let card = document.querySelector(`.schedule-card[data-id="${id}"]`);
        if(!card) return;

        if (roomId === 'TBA') {
            transformToSidebar(card, id);
        } else {
            const dayCol = document.querySelector(`.day-column[data-day="${day}"]`);
            if (dayCol) {
                transformToGrid(card, dayCol, start, end);
            }
        }
        handleDragEnd({target: card});
    }

    function transformToSidebar(card, id) {
        const sidebarList = document.getElementById('tbaList');
        card.style.opacity = '1';
        card.style.position = 'relative'; 
        card.style.top = '';
        card.style.height = '';
        card.style.left = '';
        card.style.width = '100%';
        card.classList.remove('absolute', 'bg-emerald-50', 'border-emerald-500');
        card.classList.add('bg-white', 'border-l-4', 'border-l-amber-400', 'mb-2'); 
        
        card.setAttribute('ondragstart', 'handleDragStart(event)');
        card.setAttribute('ondragend', 'handleDragEnd(event)');
        card.setAttribute('onclick', 'onCardClick(this)');

        const subj = card.dataset.subject;
        const sect = card.dataset.section;
        const dur = card.dataset.duration;
        const inst = card.dataset.instructor;
        const type = card.dataset.type || 'Lecture'; // Get Type

        card.innerHTML = `
             <div class="flex justify-between items-start pointer-events-none">
                 <div class="font-bold text-gray-800 text-[10px]">
                     ${subj} <span class="text-amber-600 ml-1">${sect}</span>
                 </div>
                 <span class="text-[9px] bg-gray-100 text-gray-500 px-1 rounded border border-gray-200">${dur}m</span>
             </div>
             <div class="text-[9px] text-gray-500 truncate pointer-events-none">${type}</div>
             <div class="text-[9px] text-gray-500 truncate pointer-events-none">${inst}</div>
        `;
        sidebarList.appendChild(card);
    }

    function transformToGrid(card, dayCol, start, end) {
        const [h, m] = start.split(':').map(Number);
        const [eh, em] = end.split(':').map(Number);
        const startDec = h + (m/60);
        const endDec = eh + (em/60);
        const top = (startDec - START_HOUR) * PIXELS_PER_HOUR;
        const height = (endDec - startDec) * PIXELS_PER_HOUR;

        card.style.opacity = '1';
        card.style.position = 'absolute';
        card.style.top = `${top}px`;
        card.style.height = `${height}px`;
        card.style.width = '94%';
        card.style.left = '3%';
        
        card.classList.remove('relative', 'bg-white', 'border-l-amber-400', 'mb-2');
        card.classList.add('bg-emerald-50', 'border-l-4', 'border-emerald-500');

        card.setAttribute('ondragstart', 'handleDragStart(event)');
        card.setAttribute('ondragend', 'handleDragEnd(event)');
        card.setAttribute('onclick', 'onCardClick(this)');

        card.dataset.start = start;
        
        const subj = card.dataset.subject;
        const sect = card.dataset.section;
        const inst = card.dataset.instructor;
        const type = card.dataset.type || 'Lecture'; // Get Type
        
        card.innerHTML = `
            <div class="flex flex-col justify-between h-full w-full pointer-events-none">
                <div>
                    <div class="font-bold text-emerald-900 text-[10px] leading-tight truncate">
                        ${subj} - ${sect}
                    </div>
                    <div class="text-[9px] text-emerald-700 font-medium truncate">
                        ${type}
                    </div>
                    <div class="text-[9px] text-emerald-600 uppercase truncate mt-0.5">
                        ${inst}
                    </div>
                </div>
                <div class="text-[8px] text-emerald-800 font-mono leading-none mt-1 border-t border-emerald-200 pt-0.5">
                    ${formatTime12(start)} - ${formatTime12(end)}
                </div>
            </div>
        `;
        dayCol.appendChild(card);
    }

    // --- RENDER ON LOAD ---
    function renderPositions() {
        document.querySelectorAll('#scheduleGrid .schedule-card').forEach(card => {
            if (card.classList.contains('tba-card')) {
                card.setAttribute('ondragend', 'handleDragEnd(event)');
                return;
            }

            const start = card.dataset.start; 
            const duration = card.dataset.duration;
            const [h, m] = start.split(':').map(Number);
            
            const top = (h + m/60 - START_HOUR) * PIXELS_PER_HOUR;
            const height = (duration / 60) * PIXELS_PER_HOUR;
            
            card.style.top = `${top}px`;
            card.style.height = `${height}px`;
            
            card.setAttribute('ondragend', 'handleDragEnd(event)');
        });
    }

    window.onload = renderPositions;
</script>
{% endblock %}