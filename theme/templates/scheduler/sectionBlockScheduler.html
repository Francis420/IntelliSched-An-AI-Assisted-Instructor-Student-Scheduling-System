{% extends 'base.html' %}

{% block title %}Section Block Manager{% endblock %}
{% block header %}Section Block Manager{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-6 flex flex-col gap-6 font-sans">

    <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <div>
            <h1 class="text-xl font-bold text-gray-800">Section Block Scheduler</h1>
            <p class="text-sm text-gray-500">Polishing schedule for Block <span class="text-emerald-600 font-bold">{{ selectedBlockLabel }}</span></p>
        </div>
        
        <div class="flex items-center gap-3">
            <form method="get" class="flex items-center gap-3">
                <label class="text-sm font-semibold text-gray-600">Semester:</label>
                <select name="semester" class="text-sm border-gray-300 border rounded-md px-3 py-2 bg-gray-50 text-gray-700 font-medium focus:ring-2 focus:ring-emerald-500 outline-none w-48" onchange="this.form.submit()">
                    {% for sem in semesters %}
                        <option value="{{ sem.semesterId }}" {% if selected_semester.semesterId == sem.semesterId %}selected{% endif %}>
                            {{ sem.term|title }} {{ sem.academicYear }}
                        </option>
                    {% endfor %}
                </select>

                <label class="text-sm font-semibold text-gray-600">Block:</label>
                <select name="block" class="text-sm border-gray-300 border rounded-md px-3 py-2 bg-gray-50 text-gray-700 font-medium focus:ring-2 focus:ring-emerald-500 outline-none w-32" onchange="this.form.submit()">
                    {% if blocks %}
                        {% for b in blocks %}
                            <option value="{{ b.value }}" {% if selectedBlock == b.value %}selected{% endif %}>
                                Block {{ b.label }}
                            </option>
                        {% endfor %}
                    {% else %}
                        <option value="">No Blocks</option>
                    {% endif %}
                </select>
            </form>

            <div class="h-8 w-px bg-gray-300 mx-1"></div>

            {% if selectedBlock and selected_semester %}
                <a href="{% url 'previewSectionBlockSchedule' selectedBlock selected_semester.semesterId %}" 
                target="_blank" 
                class="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold rounded-md shadow-sm transition-colors whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    Preview
                </a>
            {% else %}
                <button disabled
                class="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-400 border border-gray-200 text-sm font-semibold rounded-md cursor-not-allowed whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    Preview
                </button>
            {% endif %}
        </div>
    </div>

    <div class="flex-1 bg-white border rounded-lg shadow overflow-hidden flex flex-col relative h-[85vh]">
        <div class="grid grid-cols-8 border-b bg-gray-100 z-20">
            <div class="py-3 text-center text-xs font-bold text-gray-400 border-r uppercase tracking-wide">Time</div>
            {% for day in days %}
                <div class="py-3 text-center text-sm font-bold text-gray-700 border-r">{{ day }}</div>
            {% endfor %}
        </div>

        <div class="grid grid-cols-8 flex-1 overflow-y-auto relative" id="scheduleGrid">
            
            <div class="border-r bg-gray-50 relative z-10">
                {% for t in times %}
                    <div class="h-12 border-b text-[10px] text-gray-400 flex items-start justify-center pt-1 font-mono">
                        {{ t|time:"g:i A" }}
                    </div>
                {% endfor %}
            </div>

            {% for day in days %}
            <div class="relative border-r day-column" data-day="{{ day }}">
                
                {% for t in times %}
                    {% if t.hour == 12 %}
                        <div class="h-12 border-b bg-gray-200/50 flex items-center justify-center">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest select-none">Lunch Break</span>
                        </div>
                    {% else %}
                        <div class="h-12 border-b border-gray-100 transition-colors cursor-pointer slot-trigger" 
                             data-time="{{ t|time:'H:i' }}"
                             ondragover="handleDragOver(event)"
                             ondragleave="handleDragLeave(this)"
                             ondrop="handleDrop(event, this)"></div>
                    {% endif %}
                {% endfor %}

                <div class="conflict-layer absolute inset-0 pointer-events-none z-0"></div>

                {% for ge in gen_eds %}
                    {% if ge.dayOfWeek == day %}
                    <div class="absolute w-[94%] left-[3%] rounded bg-gray-100 border-l-4 border-gray-400 text-xs p-2 shadow z-10 opacity-90 select-none cursor-not-allowed flex flex-col gap-1"
                         data-start="{{ ge.startTime|time:'H:i' }}"
                         data-end="{{ ge.endTime|time:'H:i' }}">
                        <div class="font-bold text-gray-600 truncate">{{ ge.code }} ðŸ”’</div>
                        <div class="text-[9px] text-gray-500 uppercase font-semibold">General Education</div>
                    </div>
                    {% endif %}
                {% endfor %}

                {% for sched in schedules %}
                    {% if sched.dayOfWeek == day %}
                    <div class="schedule-card absolute w-[94%] left-[3%] rounded bg-emerald-50 border-l-4 border-emerald-500 p-1.5 shadow-sm hover:shadow-md cursor-move transition-all z-20 hover:scale-[1.02] group overflow-hidden"
                            draggable="true"
                            ondragstart="handleDragStart(event, this)"
                            data-id="{{ sched.scheduleId }}"
                            data-start="{{ sched.startTime|time:'H:i' }}"
                            data-duration="{{ sched.duration_minutes }}"
                            data-instructor="{{ sched.instructor.instructorId }}"
                            data-subject="{{ sched.subject.code }}"
                            onclick="activateEditMode(this)">
                            
                        <div class="flex flex-col justify-between h-full w-full pointer-events-none">
                            <div>
                                <div class="font-bold text-emerald-900 text-xs leading-tight truncate">
                                    {{ sched.subject.code }}
                                </div>
                                <div class="text-emerald-700 font-medium text-[11px] leading-tight mt-0.5 truncate">
                                    {{ sched.instructor.full_name }}
                                </div>
                            </div>
                            <div class="flex justify-between items-end border-t border-emerald-200 pt-1 mt-1">
                                <div class="text-[10px] text-emerald-800 font-mono font-semibold">
                                    {{ sched.startTime|time:"g:iA"|lower }} - {{ sched.endTime|time:"g:iA"|lower }}
                                </div>
                                <div class="text-[10px] font-bold text-emerald-600">
                                    <span class="bg-emerald-200 px-1.5 py-0.5 rounded">
                                        {{ sched.room.roomCode|default:"TBA" }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div id="editModal" class="hidden fixed bottom-6 right-6 z-50">
    <div class="bg-white p-4 rounded-lg shadow-xl border border-emerald-200 w-80">
        <div class="flex justify-between items-start mb-2">
            <h3 class="font-bold text-gray-800">Move Class</h3>
            <button onclick="cancelEdit()" class="text-gray-400 hover:text-red-500 text-xl">&times;</button>
        </div>
        <p class="text-sm text-gray-600 mb-3">Dragging: <span id="modalSubject" class="font-bold text-emerald-600"></span></p>
        <div id="conflictLoading" class="hidden text-xs text-emerald-500 mb-2">Checking instructor schedule...</div>
        <div class="text-xs bg-amber-50 text-amber-700 p-2 rounded border border-amber-100 mb-3">
            <strong>Pro Tip:</strong> Drop on any white slot to reschedule. Red areas indicate instructor conflicts.
        </div>
    </div>
</div>

<script>
    const START_HOUR = 7; 
    const PIXELS_PER_HOUR = 48; 
    let activeScheduleId = null;
    let activeDuration = 0;

    const API_URL_CONFLICTS = "{% url 'getInstructorConflicts' %}";
    const API_URL_UPDATE = "{% url 'updateScheduleSlot' %}";

    // --- 1. NATIVE DRAG AND DROP LOGIC ---
    function handleDragStart(e, element) {
        // Reuse activation for visual feedback/conflict checking
        activateEditMode(element);
        
        e.dataTransfer.setData("text/plain", element.dataset.id);
        e.dataTransfer.effectAllowed = "move";
        
        // Visual cue for dragging
        setTimeout(() => element.classList.add('opacity-40'), 0);
    }

    function handleDragOver(e) {
        e.preventDefault(); 
        e.dataTransfer.dropEffect = "move";
        e.currentTarget.classList.add('bg-emerald-100');
    }

    function handleDragLeave(slot) {
        slot.classList.remove('bg-emerald-100');
    }

    function handleDrop(e, slotElement) {
        e.preventDefault();
        slotElement.classList.remove('bg-emerald-100');
        
        if(!activeScheduleId) return;

        const dayColumn = slotElement.closest('.day-column');
        const newDay = dayColumn.dataset.day;
        const slotTime = slotElement.dataset.time; 
        
        // Calculate 30-min precision based on drop position within slot
        const slotRect = slotElement.getBoundingClientRect();
        const dropY = e.clientY - slotRect.top;
        let finalM = (dropY > 24) ? 30 : 0; 
        
        const [baseH] = slotTime.split(':').map(Number);
        const startDec = baseH + (finalM/60);
        const endDec = startDec + (activeDuration / 60);

        // 1. Lunch break validation
        if (startDec < 13 && endDec > 12) {
            alert("Cannot schedule during Lunch Break (12:00 PM - 1:00 PM).");
            cancelEdit();
            return; 
        }

        // --- 2. STRICT CONFLICT CHECK (Red Box Collision) ---
        const conflictLayer = dayColumn.querySelector('.conflict-layer');
        let hasConflict = false;
        let conflictReason = "";

        if (conflictLayer) {
            const conflicts = conflictLayer.querySelectorAll('.conflict-box');
            
            for (const box of conflicts) {
                // Get position/height of the red box
                const boxTop = parseFloat(box.style.top);
                const boxHeight = parseFloat(box.style.height);

                // Convert pixels to decimal hours
                // Time = (Pixels / 48) + 7
                const conflictStart = (boxTop / PIXELS_PER_HOUR) + START_HOUR;
                const conflictEnd = conflictStart + (boxHeight / PIXELS_PER_HOUR);

                // Check for Overlap (with small buffer for precision)
                if (startDec < conflictEnd - 0.01 && endDec > conflictStart + 0.01) {
                    hasConflict = true;
                    // Extract text from the red box
                    conflictReason = box.innerText.replace('BUSY', '').trim() || "Instructor is busy";
                    break; 
                }
            }
        }

        if (hasConflict) {
            alert(`Instructor Conflict! ${conflictReason}`);
            cancelEdit(); // Reverts the visual state
            return; // STOP EXECUTION
        }
        // --- 3. PROCEED WITH UPDATE ---

        const newStartStr = `${baseH.toString().padStart(2,'0')}:${finalM===0?'00':'30'}`;
        const eh = Math.floor(endDec);
        const em = Math.round((endDec % 1) * 60);
        const newEndStr = `${eh.toString().padStart(2,'0')}:${em.toString().padStart(2,'0')}`;

        updateSchedule(activeScheduleId, newDay, newStartStr, newEndStr);
    }

    // --- 2. API & VISUAL UPDATE LOGIC ---
    async function updateSchedule(id, day, start, end) {
        const csrftoken = getCookie('csrftoken');
        try {
            const res = await fetch(API_URL_UPDATE, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
                body: JSON.stringify({scheduleId: id, day: day, startTime: start, endTime: end})
            });

            if(res.ok) {
                const data = await res.json();
                if(data.success) {
                    moveCardVisuals(id, day, start, end);
                    cancelEdit();
                } else {
                    alert(data.message);
                    cancelEdit();
                }
            }
        } catch(e) {
            console.error(e);
            alert("Connection error.");
            cancelEdit();
        }
    }

    function moveCardVisuals(id, newDay, newStart, newEnd) {
        const card = document.querySelector(`.schedule-card[data-id="${id}"]`);
        const targetColumn = document.querySelector(`.day-column[data-day="${newDay}"]`);

        if (card && targetColumn) {
            card.dataset.start = newStart;
            card.dataset.end = newEnd;
            if (card.parentElement !== targetColumn) targetColumn.appendChild(card);
            
            const timeDiv = card.querySelector('.font-mono');
            if(timeDiv) timeDiv.innerText = formatTimeLabel(newStart);
            
            renderPositions();
        }
    }

    // --- 3. UTILS & UI ---
    function renderPositions() {
        const cards = document.querySelectorAll('.schedule-card, .absolute.bg-gray-100');
        cards.forEach(card => {
            const start = card.dataset.start; 
            const end = card.dataset.end; 
            let duration = card.dataset.duration;

            if(!duration && end) {
                const [sh, sm] = start.split(':').map(Number);
                const [eh, em] = end.split(':').map(Number);
                duration = ((eh*60 + em) - (sh*60 + sm));
            }

            const [h, m] = start.split(':').map(Number);
            const startDecimal = h + (m/60);
            const top = (startDecimal - START_HOUR) * PIXELS_PER_HOUR;
            const height = (duration / 60) * PIXELS_PER_HOUR;
            
            card.style.top = `${top}px`;
            card.style.height = `${height}px`;
        });
    }

    function activateEditMode(element) {
        activeScheduleId = element.dataset.id;
        activeDuration = parseInt(element.dataset.duration);
        element.classList.add('ring-2', 'ring-emerald-500', 'z-50'); 
        document.getElementById('modalSubject').innerText = element.dataset.subject;
        document.getElementById('editModal').classList.remove('hidden');
        fetchConflicts(element.dataset.instructor, activeScheduleId);
    }

    function cancelEdit(hideModal = true) {
        activeScheduleId = null;
        if(hideModal) document.getElementById('editModal').classList.add('hidden');
        document.querySelectorAll('.conflict-box').forEach(el => el.remove());
        document.querySelectorAll('.schedule-card').forEach(el => {
            el.classList.remove('ring-2', 'ring-emerald-500', 'z-50', 'opacity-40');
        });
    }

    async function fetchConflicts(instructorId, currentId) {
        const loader = document.getElementById('conflictLoading');
        if(loader) loader.classList.remove('hidden');

        // 1. Clear existing conflict boxes before fetching new ones
        document.querySelectorAll('.conflict-box').forEach(el => el.remove());

        try {
            // 2. Get the Semester ID
            const semesterEl = document.querySelector('select[name="semester"]');
            const semesterId = semesterEl ? semesterEl.value : '';

            // 3. Updated URL: Added &source=sectionBlockScheduler
            const url = `${API_URL_CONFLICTS}?instructorId=${instructorId}&scheduleId=${currentId}&semesterId=${semesterId}&source=sectionBlockScheduler`;
            
            const res = await fetch(url);
            const data = await res.json();
            
            if(loader) loader.classList.add('hidden');

            data.busySlots.forEach(slot => {
                const dayCol = document.querySelector(`.day-column[data-day="${slot.day}"] .conflict-layer`);
                if(dayCol) {
                    const [sh, sm] = slot.startTime.split(':').map(Number);
                    const [eh, em] = slot.endTime.split(':').map(Number);
                    const top = (sh + sm/60 - START_HOUR) * PIXELS_PER_HOUR;
                    const height = (eh + em/60 - (sh + sm/60)) * PIXELS_PER_HOUR;
                    
                    const div = document.createElement('div');
                    // Added 'pointer-events-none' so it doesn't block dropping items
                    div.className = "conflict-box absolute w-full left-0 bg-red-100/90 border-y border-red-400 z-10 p-1 text-center flex flex-col justify-center pointer-events-none";
                    div.style.top = `${top}px`;
                    div.style.height = `${height}px`;
                    
                    // Display specific reason (e.g., "Instructor teaching IT 101")
                    div.innerHTML = `
                        <span class="text-[9px] font-bold text-red-800 uppercase">BUSY</span>
                        <span class="text-[8px] text-red-800 leading-tight line-clamp-2">${slot.reason}</span>
                    `;
                    dayCol.appendChild(div);
                }
            });
        } catch(e) { 
            console.error(e); 
            if(loader) loader.classList.add('hidden');
        }
    }

    function formatTimeLabel(timeStr) {
        const [h, m] = timeStr.split(':').map(Number);
        const ampm = h >= 12 ? 'pm' : 'am';
        const h12 = h % 12 || 12;
        return `${h12}:${m.toString().padStart(2,'0')}${ampm}`;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    window.onload = renderPositions;
    document.addEventListener('keydown', e => { if(e.key === "Escape") cancelEdit(); });
</script>
{% endblock %}