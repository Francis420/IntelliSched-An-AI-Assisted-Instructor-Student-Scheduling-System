{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto bg-white p-8 mt-10 rounded-xl shadow">
  <h2 class="text-2xl font-bold text-indigo-600 mb-6">Create Student Account</h2>

  <form method="POST" class="space-y-5">
    {% csrf_token %}

    <div>
      <label for="username" class="block font-medium text-gray-700">Username</label>
      <input type="text" name="username" id="username" required
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
      <span class="availability-message text-sm"></span>
    </div>

    <div>
      <label for="email" class="block font-medium text-gray-700">Email</label>
      <input type="email" name="email" required
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
    </div>

    <div>
      <label for="password" class="block font-medium text-gray-700">Password</label>
      <input type="password" name="password" required
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
    </div>

    <div>
      <label for="firstName" class="block font-medium text-gray-700">First Name</label>
      <input type="text" name="firstName" required
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
    </div>

    <div>
      <label for="lastName" class="block font-medium text-gray-700">Last Name</label>
      <input type="text" name="lastName" required
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
    </div>

    <div>
      <label for="middleInitial" class="block font-medium text-gray-700">Middle Initial</label>
      <input type="text" name="middleInitial" maxlength="1"
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
    </div>

    <div>
      <label for="studentId" class="block font-medium text-gray-700">Student ID</label>
      <input type="text" name="studentId" id="studentId" required
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
      <span class="availability-message text-sm"></span>
    </div>

    <div>
      <button type="submit"
              class="w-full bg-indigo-600 text-white font-medium py-2 px-4 rounded-md hover:bg-indigo-700 transition opacity-50"
              disabled>
        Create Account
      </button>
    </div>
  </form>
</div>

<!-- JS: availability check -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const usernameInput = document.querySelector('#username');
  const studentIdInput = document.querySelector('#studentId');
  const submitBtn = document.querySelector('button[type="submit"]');

  let usernameValid = false;
  let studentIdValid = false;

  const updateSubmitState = () => {
    if (usernameValid && studentIdValid) {
      submitBtn.disabled = false;
      submitBtn.classList.remove('opacity-50');
    } else {
      submitBtn.disabled = true;
      submitBtn.classList.add('opacity-50');
    }
  };

  const showAvailabilityMessage = (element, isAvailable, message) => {
    let msgElem = element.parentNode.querySelector('.availability-message');
    if (!msgElem) {
      msgElem = document.createElement('span');
      msgElem.classList.add('availability-message', 'text-sm');
      element.parentNode.appendChild(msgElem);
    }
    msgElem.textContent = message;
    msgElem.style.color = isAvailable ? 'green' : 'red';
  };

  const debounce = (func, delay) => {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => func.apply(this, args), delay);
    };
  };

  const checkAvailability = debounce((url, value, element, setValidFlag) => {
    fetch(`${url}?value=${encodeURIComponent(value)}`)
      .then(res => {
        if (!res.ok) throw new Error('Network error');
        return res.json();
      })
      .then(data => {
        showAvailabilityMessage(element, data.isAvailable, data.message);
        setValidFlag(data.isAvailable);
        updateSubmitState();
      })
      .catch(() => {
        showAvailabilityMessage(element, false, 'Error checking availability');
        setValidFlag(false);
        updateSubmitState();
      });
  }, 400);

  usernameInput.addEventListener('input', () => {
    if (usernameInput.value.trim() !== '') {
      checkAvailability("{% url 'check_username_availability' %}", usernameInput.value, usernameInput, v => usernameValid = v);
    } else {
      usernameValid = false;
      updateSubmitState();
    }
  });

  studentIdInput.addEventListener('input', () => {
    if (studentIdInput.value.trim() !== '') {
      checkAvailability("{% url 'check_studentid_availability' %}", studentIdInput.value, studentIdInput, v => studentIdValid = v);
    } else {
      studentIdValid = false;
      updateSubmitState();
    }
  });
});
</script>
{% endblock %}
