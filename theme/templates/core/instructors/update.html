{% extends 'base.html' %}
{% load static %}

{% block title %}Update Instructor Account{% endblock %}
{% block header %}Update Instructor Account{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto bg-white p-8 mt-10 rounded-xl shadow">
  <h2 class="text-2xl font-bold text-indigo-600 mb-6">Update Instructor Account</h2>

  <form method="POST" class="space-y-5">
    {% csrf_token %}

    <!-- First Name -->
    <div>
      <label for="firstName" class="block font-medium text-gray-700">First Name</label>
      <input type="text" name="firstName" value="{{ user.firstName }}" required
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
    </div>

    <!-- Last Name -->
    <div>
      <label for="lastName" class="block font-medium text-gray-700">Last Name</label>
      <input type="text" name="lastName" value="{{ user.lastName }}" required
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
    </div>

    <!-- Email -->
    <div>
      <label for="email" class="block font-medium text-gray-700">Email</label>
      <input type="email" name="email" value="{{ user.email }}" required
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
    </div>

    <!-- Instructor ID -->
    <div>
      <label for="instructorId" class="block font-medium text-gray-700">Instructor ID</label>
      <input type="text" name="instructorId" id="instructorId" value="{{ instructor.instructorId }}" required
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
      <span id="instructor-check" class="text-sm"></span>
    </div>

    <!-- Employment Type -->
    <div>
      <label for="employmentType" class="block font-medium text-gray-700">Employment Type</label>
      <select name="employmentType" required
              class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-indigo-500 focus:border-indigo-500">
        <option value="">Select Type</option>
        <option value="permanent" {% if instructor.employmentType == 'permanent' %}selected{% endif %}>
              Permanent
          </option>
          
          <option value="part-time" {% if instructor.employmentType == 'part-time' %}selected{% endif %}>
              Part-time
          </option>
          
          <option value="overload" {% if instructor.employmentType == 'overload' %}selected{% endif %}>
              Part-time (Overload)
          </option>
          
          <option value="on-leave" {% if instructor.employmentType == 'on-leave' %}selected{% endif %}>
              On-Leave
          </option>
          
          <option value="retired" {% if instructor.employmentType == 'retired' %}selected{% endif %}>
              Retired
          </option>
      </select>
    </div>

    <!-- Rank -->
    <div>
      <label for="rank" class="block font-medium text-gray-700">Rank</label>
      <select name="rank" id="rank"
              class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-indigo-500 focus:border-indigo-500">
        <option value="">Select Rank</option>
        {% for rank in ranks %}
          <option value="{{ rank.rankId }}" {% if instructor.rank and instructor.rank.rankId == rank.rankId %}selected{% endif %}>
            {{ rank.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Designation -->
    <div>
      <label for="designation" class="block font-medium text-gray-700">Designation (optional)</label>
      <select name="designation" id="designation"
              class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-indigo-500 focus:border-indigo-500">
        <option value="">None</option>
        {% for d in designations %}
          <option value="{{ d.designationId }}" {% if instructor.designation and instructor.designation.designationId == d.designationId %}selected{% endif %}>
            {{ d.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Academic Attainment -->
    <div>
      <label for="academicAttainment" class="block font-medium text-gray-700">Academic Attainment</label>
      <select name="academicAttainment" id="academicAttainment"
              class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-indigo-500 focus:border-indigo-500">
        <option value="">Select Academic Attainment</option>
        {% for a in attainments %}
          <option value="{{ a.attainmentId }}" {% if instructor.academicAttainment and instructor.academicAttainment.attainmentId == a.attainmentId %}selected{% endif %}>
            {{ a.name }}{% if a.suffix %}, {{ a.suffix }}{% endif %}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="flex space-x-3">
      <button type="submit"
              class="flex-1 bg-indigo-600 text-white font-medium py-2 px-4 rounded-md hover:bg-indigo-700 transition">
        Update Account
      </button>

      <a href="javascript:history.back()" 
        class="flex-1 text-center bg-gray-300 text-black font-medium py-2 px-4 rounded-md hover:bg-gray-400 transition">
        Back
      </a>
    </div>
  </form>
</div>

<!-- JS: Instructor ID availability check -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const instructorIdInput = document.querySelector('#instructorId');
  const currentInstructorId = "{{ instructor.instructorId }}";  // avoid self-duplication

  const showAvailabilityMessage = (element, isAvailable, message) => {
    let msgElem = element.parentNode.querySelector('.availability-message');
    if (!msgElem) {
      msgElem = document.createElement('span');
      msgElem.classList.add('availability-message', 'text-sm');
      element.parentNode.appendChild(msgElem);
    }
    msgElem.textContent = message;
    msgElem.style.color = isAvailable ? 'green' : 'red';
  };

  const debounce = (func, delay) => {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => func.apply(this, args), delay);
    };
  };

  const checkAvailability = debounce((url, value, element) => {
    fetch(`${url}?value=${encodeURIComponent(value)}&exclude=${encodeURIComponent(currentInstructorId)}`)
      .then(res => res.json())
      .then(data => {
        showAvailabilityMessage(element, data.isAvailable, data.message);
      })
      .catch(() => {
        showAvailabilityMessage(element, false, 'Error checking availability');
      });
  }, 400);

  if (instructorIdInput) {
    instructorIdInput.addEventListener('input', () => {
      if (instructorIdInput.value.trim() !== '') {
        checkAvailability("{% url 'check_instructorid_availability' %}", instructorIdInput.value, instructorIdInput);
      }
    });
  }
});
</script>
{% endblock %}
