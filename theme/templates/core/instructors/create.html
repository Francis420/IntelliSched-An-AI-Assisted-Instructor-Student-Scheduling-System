{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="max-w-2xl mx-auto bg-white p-8 mt-10 rounded-xl shadow">
  <h2 class="text-2xl font-bold text-indigo-600 mb-6">Create Instructor Account</h2>

  <form method="POST" class="space-y-5">
    {% csrf_token %}

    <div>
      <label for="username" class="block font-medium text-gray-700">Username</label>
      <input type="text" name="username" id="username" required
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
      <span id="username-check" class="text-sm"></span>
    </div>

    <div>
      <label for="email" class="block font-medium text-gray-700">Email</label>
      <input type="email" name="email" required
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
    </div>

    <div>
      <label for="password" class="block font-medium text-gray-700">Password</label>
      <input type="password" name="password" required
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
    </div>

    <div>
      <label for="firstName" class="block font-medium text-gray-700">First Name</label>
      <input type="text" name="firstName" required
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
    </div>

    <div>
      <label for="lastName" class="block font-medium text-gray-700">Last Name</label>
      <input type="text" name="lastName" required
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
    </div>

    <div>
      <label for="instructorId" class="block font-medium text-gray-700">Instructor ID</label>
      <input type="text" name="instructorId" id="instructorId" required
             class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
      <span id="instructor-check" class="text-sm"></span>
    </div>

    <div>
      <label for="employmentType" class="block font-medium text-gray-700">Employment Type</label>
      <select name="employmentType" required
              class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-indigo-500 focus:border-indigo-500">
        <option value="">Select Type</option>
        <option value="full-time">Full-Time</option>
        <option value="part-time">Part-Time</option>
      </select>
    </div>

    <div>
      <label for="rank" class="block font-medium text-gray-700">Rank</label>
      <select name="rank" id="rank"
              class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-indigo-500 focus:border-indigo-500">
        <option value="">Select Rank</option>
        {% for rank in ranks %}
          <option value="{{ rank.rankId }}">{{ rank.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label for="designation" class="block font-medium text-gray-700">Designation (optional)</label>
      <select name="designation" id="designation"
              class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-indigo-500 focus:border-indigo-500">
        <option value="">None</option>
        {% for d in designations %}
          <option value="{{ d.designationId }}">{{ d.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label for="attainment" class="block font-medium text-gray-700">Academic Attainment</label>
      <select name="attainment" id="attainment"
              class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-indigo-500 focus:border-indigo-500">
        <option value="">Select Academic Attainment</option>
        {% for a in attainments %}
          <option value="{{ a.attainmentId }}">{{ a.name }}{% if a.suffix %}, {{ a.suffix }}{% endif %}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <button type="submit"
              class="w-full bg-indigo-600 text-white font-medium py-2 px-4 rounded-md hover:bg-indigo-700 transition opacity-50"
              disabled>
        Create Account
      </button>
    </div>
  </form>
</div>

<!-- JS: availability check -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const usernameInput = document.querySelector('#username');
  const instructorIdInput = document.querySelector('#instructorId');
  const submitBtn = document.querySelector('button[type="submit"]');
  let usernameValid = false;
  let instructorIdValid = false;

  const updateSubmitState = () => {
    if (usernameValid && instructorIdValid) {
      submitBtn.disabled = false;
      submitBtn.classList.remove('opacity-50');
    } else {
      submitBtn.disabled = true;
      submitBtn.classList.add('opacity-50');
    }
  };

  const showAvailabilityMessage = (element, isAvailable, message) => {
    let msgElem = element.parentNode.querySelector('.availability-message');
    if (!msgElem) {
      msgElem = document.createElement('span');
      msgElem.classList.add('availability-message', 'text-sm');
      element.parentNode.appendChild(msgElem);
    }
    msgElem.textContent = message;
    msgElem.style.color = isAvailable ? 'green' : 'red';
  };

  const debounce = (func, delay) => {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => func.apply(this, args), delay);
    };
  };

  const checkAvailability = debounce((url, value, element, setValidFlag) => {
    fetch(`${url}?value=${encodeURIComponent(value)}`)
      .then(res => {
        if (!res.ok) throw new Error('Network error');
        return res.json();
      })
      .then(data => {
        showAvailabilityMessage(element, data.isAvailable, data.message);
        setValidFlag(data.isAvailable);
        updateSubmitState();
      })
      .catch(() => {
        showAvailabilityMessage(element, false, 'Error checking availability');
        setValidFlag(false);
        updateSubmitState();
      });
  }, 400);

  usernameInput.addEventListener('input', () => {
    if (usernameInput.value.trim() !== '') {
      checkAvailability("{% url 'check_username_availability' %}", usernameInput.value, usernameInput, (v) => usernameValid = v);
    } else {
      usernameValid = false;
      updateSubmitState();
    }
  });

  instructorIdInput.addEventListener('input', () => {
    if (instructorIdInput.value.trim() !== '') {
      checkAvailability("{% url 'check_instructorid_availability' %}", instructorIdInput.value, instructorIdInput, (v) => instructorIdValid = v);
    } else {
      instructorIdValid = false;
      updateSubmitState();
    }
  });
});
</script>
{% endblock %}
