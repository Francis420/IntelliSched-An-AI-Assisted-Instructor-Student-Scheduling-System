{% extends 'base.html' %}
{% block title %}Semesters{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto mt-10 px-4 sm:px-6 lg:px-8">
  <h2 class="text-2xl font-bold text-gray-800 mb-6">Semesters</h2>

  <!-- Flash Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="mb-4 px-4 py-2 rounded text-white
                  {% if message.tags == 'error' %}bg-red-500{% else %}bg-green-500{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <!-- Search Bar -->
  <div class="mb-6">
    <input type="text" id="searchInput"
           class="w-full sm:w-1/2 border border-gray-300 rounded-md py-2 px-3 focus:ring-blue-500 focus:border-blue-500"
           placeholder="Search semesters..."
           value="{{ query }}">
  </div>

  <!-- Add Semester Button -->
  <div class="mb-4 text-right">
    <a href="{% url 'semesterCreate' %}"
       class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition">
      + Create New Semester
    </a>
  </div>

  <div id="semesterContainer">
    {% include 'scheduling/semesters/_table.html' %}
  </div>

  <!-- Pagination -->
  <div id="paginationControls" class="mt-6 flex justify-center"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const searchInput = document.getElementById("searchInput");
    const container = document.getElementById("semesterContainer");
    const paginationControls = document.getElementById("paginationControls");

    let savedQuery = localStorage.getItem("semesterQuery") || "";
    let savedPage = localStorage.getItem("semesterPage") || 1;

    if (!searchInput.value && savedQuery) {
        searchInput.value = savedQuery;
    }

    function fetchData(page = 1) {
        const query = searchInput.value.trim();
        localStorage.setItem("semesterQuery", query);
        localStorage.setItem("semesterPage", page);

        fetch(`{% url 'semesterListLive' %}?q=${encodeURIComponent(query)}&page=${page}`)
            .then(res => res.json())
            .then(data => {
                container.innerHTML = data.html;
                renderPagination(data.page, data.num_pages);
            });
    }

    function renderPagination(current, total) {
        if (total <= 1) {
            paginationControls.innerHTML = "";
            return;
        }
        let html = `<nav><ul class="flex space-x-2">`;
        for (let i = 1; i <= total; i++) {
            html += `<li>
                        <a href="#" data-page="${i}" 
                           class="px-3 py-1 rounded-md ${i == current ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}">
                          ${i}
                        </a>
                     </li>`;
        }
        html += `</ul></nav>`;
        paginationControls.innerHTML = html;

        paginationControls.querySelectorAll("a").forEach(el => {
            el.addEventListener("click", function(e) {
                e.preventDefault();
                fetchData(this.dataset.page);
            });
        });
    }

    let typingTimer;
    searchInput.addEventListener("input", () => {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => fetchData(1), 300);
    });

    fetchData(savedPage);
});
</script>
{% endblock %}
