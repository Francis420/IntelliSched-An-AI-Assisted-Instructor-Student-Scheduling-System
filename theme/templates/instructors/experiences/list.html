{% extends 'base.html' %}
{% block title %}Professional Experience{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto mt-10 px-4 sm:px-6 lg:px-8">
  
  <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
      <h2 class="text-2xl font-bold text-gray-800">Professional Experience</h2>
      <a href="{% url 'experienceCreate' %}"
         class="inline-flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition shadow-sm gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
        Add Experience
      </a>
  </div>

  <div class="mb-6">
    <div class="relative w-full sm:w-1/2">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
        </div>
        <input type="text" id="searchInput"
               class="block w-full pl-10 border border-gray-300 rounded-md py-2 px-3 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm transition"
               placeholder="Search title, company, location, or type..."
               value="{{ query|default:'' }}">
    </div>
  </div>

  <div id="experienceContainer" class="min-h-[200px]">
    {% include 'instructors/experiences/_table.html' %}
  </div>

  <div id="paginationControls" class="mt-6 flex justify-center">
    {% if experiences.has_other_pages %}
      <nav class="flex space-x-2">
        {% if experiences.has_previous %}
          <a href="?page={{ experiences.previous_page_number }}" class="px-3 py-1 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">Prev</a>
        {% endif %}
        
        {% for i in experiences.paginator.page_range %}
          {% if experiences.number == i %}
            <span class="px-3 py-1 rounded-md bg-blue-600 text-white">{{ i }}</span>
          {% else %}
            <a href="?page={{ i }}" class="px-3 py-1 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">{{ i }}</a>
          {% endif %}
        {% endfor %}
  
        {% if experiences.has_next %}
          <a href="?page={{ experiences.next_page_number }}" class="px-3 py-1 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">Next</a>
        {% endif %}
      </nav>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const searchInput = document.getElementById("searchInput");
    const container = document.getElementById("experienceContainer");
    const paginationControls = document.getElementById("paginationControls");
    let typingTimer;
    const doneTypingInterval = 300; // Wait 300ms after typing stops

    // Function to fetch data
    function fetchData(page = 1) {
        const query = searchInput.value.trim();
        
        // Construct URL for the live view
        const url = `{% url 'experienceListLive' %}?q=${encodeURIComponent(query)}&page=${page}`;

        // Add opacity to indicate loading
        container.style.opacity = '0.5';

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error("Network response was not ok");
                return response.json();
            })
            .then(data => {
                // Update table content
                container.innerHTML = data.html;
                container.style.opacity = '1';
                
                // Update Pagination
                renderPagination(data.page, data.num_pages);
            })
            .catch(error => {
                console.error("Error fetching experiences:", error);
                container.style.opacity = '1';
            });
    }

    // Function to rebuild pagination buttons dynamically
    function renderPagination(current, total) {
        if (total <= 1) {
            paginationControls.innerHTML = "";
            return;
        }

        let html = `<nav class="flex space-x-2">`;
        
        // Previous Button
        if (current > 1) {
            html += `<a href="#" data-page="${current - 1}" class="pagination-link px-3 py-1 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">Prev</a>`;
        }

        // Page Numbers (Simple logic: show all for now, or you can implement a window)
        for (let i = 1; i <= total; i++) {
            if (i === current) {
                html += `<span class="px-3 py-1 rounded-md bg-blue-600 text-white">${i}</span>`;
            } else {
                html += `<a href="#" data-page="${i}" class="pagination-link px-3 py-1 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">${i}</a>`;
            }
        }

        // Next Button
        if (current < total) {
            html += `<a href="#" data-page="${current + 1}" class="pagination-link px-3 py-1 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">Next</a>`;
        }

        html += `</nav>`;
        paginationControls.innerHTML = html;

        // Re-attach event listeners to new pagination links
        document.querySelectorAll(".pagination-link").forEach(link => {
            link.addEventListener("click", function(e) {
                e.preventDefault();
                fetchData(this.dataset.page);
            });
        });
    }

    // Event Listener: Search Input (Debounced)
    searchInput.addEventListener("input", () => {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => fetchData(1), doneTypingInterval);
    });

    // Handle initial pagination links (generated by Django template) for AJAX consistency
    // This allows the initial page load links to work via AJAX instead of full reload
    document.querySelectorAll("#paginationControls a").forEach(link => {
        link.addEventListener("click", function(e) {
            // Check if it's a Django generated link (usually contains ?page=X)
            const urlParams = new URLSearchParams(this.getAttribute("href"));
            const page = urlParams.get("page");
            if (page) {
                e.preventDefault();
                fetchData(page);
            }
        });
    });
});
</script>
{% endblock %}