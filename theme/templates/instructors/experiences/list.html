{% extends 'base.html' %}
{% block title %}Instructor Experiences{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto mt-10 px-4 sm:px-6 lg:px-8">
  <h2 class="text-2xl font-bold text-gray-800 mb-6">Work Experiences</h2>

  <!-- Search Bar -->
  <div class="mb-6">
    <input type="text" id="searchInput"
           class="w-full sm:w-1/2 border border-gray-300 rounded-md py-2 px-3 focus:ring-blue-500 focus:border-blue-500"
           placeholder="Search experiences..."
           value="{{ query }}">
  </div>

  <div class="mb-4 text-right">
    <a href="{% url 'experienceCreate' %}"
       class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition">
      + Add Experience
    </a>
  </div>

  <!-- Experiences Container -->
  <div id="experienceContainer">
    {% include 'instructors/experiences/_cards.html' %}
  </div>

  <!-- Pagination -->
  <div id="paginationControls" class="mt-6 flex justify-center"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const searchInput = document.getElementById("searchInput");
    const container = document.getElementById("experienceContainer");
    const paginationControls = document.getElementById("paginationControls");

    let savedQuery = localStorage.getItem("experienceQuery") || "";
    let savedPage = localStorage.getItem("experiencePage") || 1;

    if (!searchInput.value && savedQuery) {
        searchInput.value = savedQuery;
    }

    function fetchData(page = 1) {
        const query = searchInput.value.trim();
        localStorage.setItem("experienceQuery", query);
        localStorage.setItem("experiencePage", page);

        fetch(`{% url 'experienceListLive' %}?q=${encodeURIComponent(query)}&page=${page}`)
            .then(res => res.json())
            .then(data => {
                container.innerHTML = data.html;
                renderPagination(data.page, data.num_pages);
            });
    }

    function renderPagination(current, total) {
        if (total <= 1) {
            paginationControls.innerHTML = "";
            return;
        }
        let html = `<nav><ul class="flex space-x-2">`;
        for (let i = 1; i <= total; i++) {
            html += `<li>
                        <a href="#" data-page="${i}" 
                           class="px-3 py-1 rounded-md ${i == current ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}">
                          ${i}
                        </a>
                     </li>`;
        }
        html += `</ul></nav>`;
        paginationControls.innerHTML = html;

        paginationControls.querySelectorAll("a").forEach(el => {
            el.addEventListener("click", function(e) {
                e.preventDefault();
                fetchData(this.dataset.page);
            });
        });
    }

    searchInput.addEventListener("input", () => fetchData(1));
    fetchData(savedPage);
});
</script>
{% endblock %}
