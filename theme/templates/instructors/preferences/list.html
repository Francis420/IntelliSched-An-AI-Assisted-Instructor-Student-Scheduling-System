{% extends 'base.html' %}
{% block title %}Instructor Preferences{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto mt-10 p-6 bg-white rounded-2xl shadow">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-semibold text-gray-800">Subject Preferences</h2>
    <a href="{% url 'preferenceCreate' %}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
      + Add Preference
    </a>
  </div>

  <!-- Search Bar -->
  <div class="mb-6">
    <input type="text" id="searchInput"
           class="w-full sm:w-1/2 border border-gray-300 rounded-md py-2 px-3 focus:ring-blue-500 focus:border-blue-500"
           placeholder="Search preferences..."
           value="{{ query }}">
  </div>

  <div id="preferenceContainer">
    {% include 'instructors/preferences/_table.html' %}
  </div>

  <div id="paginationControls" class="mt-6 flex justify-center"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const searchInput = document.getElementById("searchInput");
    const container = document.getElementById("preferenceContainer");
    const paginationControls = document.getElementById("paginationControls");

    let savedQuery = localStorage.getItem("preferenceQuery") || "";
    let savedPage = localStorage.getItem("preferencePage") || 1;

    if (!searchInput.value && savedQuery) {
        searchInput.value = savedQuery;
    }

    function fetchData(page = 1) {
        const query = searchInput.value.trim();
        localStorage.setItem("preferenceQuery", query);
        localStorage.setItem("preferencePage", page);

        fetch(`{% url 'preferenceListLive' %}?q=${encodeURIComponent(query)}&page=${page}`)
            .then(res => res.json())
            .then(data => {
                container.innerHTML = data.html;
                renderPagination(data.page, data.num_pages);
            });
    }

    function renderPagination(current, total) {
        if (total <= 1) {
            paginationControls.innerHTML = "";
            return;
        }
        let html = `<nav><ul class="flex space-x-2">`;
        for (let i = 1; i <= total; i++) {
            html += `<li>
                        <a href="#" data-page="${i}" 
                           class="px-3 py-1 rounded-md ${i == current ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}">
                          ${i}
                        </a>
                     </li>`;
        }
        html += `</ul></nav>`;
        paginationControls.innerHTML = html;

        paginationControls.querySelectorAll("a").forEach(el => {
            el.addEventListener("click", function(e) {
                e.preventDefault();
                fetchData(this.dataset.page);
            });
        });
    }

    let typingTimer;
    searchInput.addEventListener("input", () => {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => fetchData(1), 300);
    });

    fetchData(savedPage);
});
</script>
{% endblock %}
