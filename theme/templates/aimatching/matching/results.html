{% extends "base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto p-6 bg-white shadow rounded-xl">

  <h3>
  Matching Results for Batch {{ batchId }}
  {% if generated_at %}
    <small>Ran on {{ generated_at|date:"F j, Y, g:i A" }}</small>
  {% endif %}
  </h3>


  <!-- Search Filters -->
  <div class="flex gap-4 mb-4">
    <input type="text" id="instructor-search" class="border rounded p-2 flex-1"
       placeholder="Search Instructor..." value="{{ instructor_query|default:'' }}">
  <input type="text" id="subject-search" class="border rounded p-2 flex-1"
        placeholder="Search Subject..." value="{{ subject_query|default:'' }}">
  </div>

  <div id="results-container">
    {% include "aimatching/matching/_results_table.html" %}
  </div>

</div>

<script>
function fetchResults(page = 1) {
  const subject = document.getElementById("subject-search").value;
  const instructor = document.getElementById("instructor-search").value;

  const url = new URL(window.location);
  url.searchParams.set("subject", subject);
  url.searchParams.set("instructor", instructor);
  url.searchParams.set("page", page);
  window.history.replaceState({}, "", url);

  fetch(`{% url 'matchingResultsLive' batchId=batchId %}?subject=${encodeURIComponent(subject)}&instructor=${encodeURIComponent(instructor)}&page=${page}`)
    .then(response => response.json())
    .then(data => {
      document.getElementById("results-container").innerHTML = data.html;
      attachPaginationEvents(); // âœ… re-attach events
    });
}

function attachPaginationEvents() {
  document.querySelectorAll(".live-page-link").forEach(link => {
    link.addEventListener("click", function(e) {
      e.preventDefault();
      fetchResults(this.dataset.page);
    });
  });
}

function changeSort(col) {
  const url = new URL(window.location);
  let currentSort = url.searchParams.get("sort") || "total";
  let dir = url.searchParams.get("dir") || "desc";
  if (currentSort === col) {
    dir = dir === "asc" ? "desc" : "asc";
  } else {
    dir = "asc";
  }
  url.searchParams.set("sort", col);
  url.searchParams.set("dir", dir);
  window.history.replaceState({}, "", url);
  fetchResults(1);
}

let timeout = null;
document.querySelectorAll("#subject-search, #instructor-search").forEach(input => {
  input.addEventListener("input", () => {
    clearTimeout(timeout);
    timeout = setTimeout(() => fetchResults(1), 300);
  });
});

attachPaginationEvents();
</script>
{% endblock %}
