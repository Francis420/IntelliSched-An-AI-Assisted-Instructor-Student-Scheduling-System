{% extends "base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto p-6 bg-white shadow rounded-xl">

  <h2 class="text-2xl font-bold mb-6">Top Recommended Instructors per Subject</h2>

  <!-- 🔍 Search + View All -->
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center space-x-2 w-full max-w-lg">
      <input type="text" 
             id="subjectSearch" 
             placeholder="Search subjects..." 
             class="border px-4 py-2 rounded-lg w-full">
    </div>
    <a href="{% url 'matchingResults' batchId=batchId %}" 
       class="ml-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
       id="viewAllBtn">
      View All
    </a>
  </div>

  <!-- Results -->
  <div id="subjectsContainer">
    {% for subject in subjects %}
    <div class="mb-6 border rounded-lg p-4 bg-gray-50 subject-card"
         data-name="{{ subject.name|lower }}"
         data-code="{{ subject.code|lower }}">
      <h3 class="text-xl font-semibold mb-3">{{ subject.code }} - {{ subject.name }}</h3>
      <table class="min-w-full border text-sm">
        <thead>
          <tr class="bg-gray-200">
            <th class="px-3 py-2 border">Rank</th>
            <th class="px-3 py-2 border">Instructor</th>
            <th class="px-3 py-2 border">Total Score</th>
            <th class="px-3 py-2 border">Primary Factor</th>
            <th class="px-3 py-2 border">Explanation</th>
          </tr>
        </thead>
        <tbody>
          {% for match in subject.top_matches %}
          <tr>
            <td class="px-3 py-2 border">{{ forloop.counter }}</td>
            <td class="px-3 py-2 border">{{ match.instructor.full_name }}</td>
            <td class="px-3 py-2 border font-bold text-green-700">
              {% if match.latestHistory %}
                {{ match.latestHistory.confidenceScore|floatformat:1 }}%
              {% else %}
                -
              {% endif %}
            </td>
            <td class="px-3 py-2 border">
              {% if match.latestHistory %}
                {{ match.latestHistory.primaryFactor }}
              {% else %}
                -
              {% endif %}
            </td>
            <td class="px-3 py-2 border">
              {% if match.latestHistory and match.latestHistory.explanation %}
                {% if match.latestHistory.explanation|length > 80 %}
                  <span class="short-text">{{ match.latestHistory.explanation|slice:":80" }}...</span>
                  <span class="full-text hidden">{{ match.latestHistory.explanation }}</span>
                  <button type="button" class="text-blue-600 underline toggle-btn">Show more</button>
                {% else %}
                  {{ match.latestHistory.explanation }}
                {% endif %}
              {% else %}
                <span class="text-gray-500">-</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="px-3 py-2 text-center">
              No recommended matches yet.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% empty %}
    <p class="text-gray-600">No subjects found.</p>
    {% endfor %}
  </div>
</div>

<script>
  // Subject search filter
  const searchInput = document.getElementById('subjectSearch');
  const subjectCards = document.querySelectorAll('.subject-card');
  const viewAllBtn = document.getElementById('viewAllBtn');
  let typingTimer;

  if (localStorage.getItem("subjectSearchQuery")) {
    searchInput.value = localStorage.getItem("subjectSearchQuery");
    filterSubjects(searchInput.value);
  }

  searchInput.addEventListener('keyup', () => {
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
      const query = searchInput.value;
      localStorage.setItem("subjectSearchQuery", query);
      filterSubjects(query);
    }, 300);
  });

  viewAllBtn.addEventListener('click', () => {
    localStorage.removeItem("subjectSearchQuery");
  });

  function filterSubjects(query) {
    const q = query.toLowerCase();
    subjectCards.forEach(card => {
      const name = card.dataset.name;
      const code = card.dataset.code;
      card.style.display = (name.includes(q) || code.includes(q)) ? 'block' : 'none';
    });
  }

  // Show more / Show less toggle
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const cell = btn.closest('td');
      const shortText = cell.querySelector('.short-text');
      const fullText = cell.querySelector('.full-text');

      if (fullText.classList.contains('hidden')) {
        shortText.classList.add('hidden');
        fullText.classList.remove('hidden');
        btn.textContent = 'Show less';
      } else {
        shortText.classList.remove('hidden');
        fullText.classList.add('hidden');
        btn.textContent = 'Show more';
      }
    });
  });
</script>
{% endblock %}
